---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = (await getCollection("blog")).filter((p) => !p.data.draft);
  const tags = new Set(posts.flatMap((p) => p.data.tags ?? []));
  return [...tags].map((tag) => ({ params: { tag } }));
}

const { tag } = Astro.params;

const posts = (await getCollection("blog"))
  .filter((p) => !p.data.draft && (p.data.tags ?? []).includes(tag))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
---

<BaseLayout title={`Tag: ${tag}`} description={`Articoli con tag ${tag}.`}>
  <h1>Tag: {tag}</h1>

  <ul>
    {posts.map((p) => (
      <li style="margin: 18px 0;">
        <a href={`/blog/${p.slug}/`}><strong>{p.data.title}</strong></a>
        <div style="opacity: 0.7;">
          {p.data.date.toLocaleDateString("it-IT")} · {p.data.description}
        </div>
      </li>
    ))}
  </ul>

  <p><a href="/blog/">← Tutti gli articoli</a></p>
</BaseLayout>
