---
import BaseLayout from "./BaseLayout.astro";

type Props = {
  title: string;
  description: string;
  date: Date;
  updated?: Date;
  author: string;
  tags: string[];
  canonical?: string;
  coverImage?: string;
};

const { title, description, date, updated, author, tags, canonical, coverImage } = Astro.props;

const site = Astro.site?.toString().replace(/\/$/, "") ?? "";
const url = new URL(Astro.url.pathname, site || Astro.url.origin).toString();

const imageUrl = coverImage
  ? (coverImage.startsWith("http") ? coverImage : new URL(coverImage, site || Astro.url.origin).toString())
  : undefined;

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description,
  datePublished: date.toISOString(),
  dateModified: (updated ?? date).toISOString(),
  author: [{ "@type": "Person", name: author }],
  mainEntityOfPage: url,
  url,
  ...(imageUrl ? { image: [imageUrl] } : {}),
  ...(tags?.length ? { keywords: tags.join(", ") } : {}),
};
---

<BaseLayout
  title={`${title} | Blog`}
  description={description}
  canonical={canonical}
  ogImage={coverImage}
>
  <article>
    <h1>{title}</h1>
    <p style="opacity: 0.7; margin-top: 4px;">
      {date.toLocaleDateString("it-IT")} · {author}
      {updated ? ` · aggiornato ${updated.toLocaleDateString("it-IT")}` : ""}
    </p>

    {tags?.length ? (
      <p style="margin-top: 12px;">
        {tags.map((t) => (
          <a href={`/blog/tag/${encodeURIComponent(t)}/`} style="margin-right: 10px;">
            #{t}
          </a>
        ))}
      </p>
    ) : null}

    <hr style="margin: 20px 0;" />
    <slot />
  </article>

  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
</BaseLayout>
